import os
import platform
from utils.command import Command
from utils.netScrap import look_entries, printTable
from utils.processOutputs import processLinux, processWindows, processPIP

def getPIPFreeze():
    if platform.system() == 'Windows':
        cmd = ["powershell.exe"]
    elif platform.system() == 'Linux':
        cmd = ["sh", "-c"]
    else:
        print("The OS %s is not supported!" % platform.system())
        exit(-1)
    cmd.append("pip freeze")
    command = Command(cmd, '.')
    output = command.run(timeout=5)
    #print(output[0])
    #print(output[-1])
    return processPIP(output)

def getInstalledProgram():
    print("Your OS is %s" % platform.system())
    if platform.system() == 'Windows':
        cmd1 = ["powershell.exe", "Get-ItemProperty HKLM:\\Software\\Wow6432Node\\Microsoft\\Windows\\CurrentVersion\\Uninstall\\* | Select-Object DisplayName, DisplayVersion, Publisher, InstallDate | Format-Table -AutoSize"]
        cmd2 = ["powershell.exe", "Get-ItemProperty HKLM:\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Uninstall\\* | Select-Object DisplayName, DisplayVersion, Publisher, InstallDate | Format-Table -AutoSize"]
        cmd3 = ["powershell.exe", "Get-AppxPackage | Select-Object Name, Version, Architecture, Publisher | Format-Table -AutoSize"]
        command1 = Command(cmd1, '.')
        output = command1.run(timeout=5)
        output = processWindows(output)
        command2 = Command(cmd2, '.')
        tmp = command2.run(timeout=5)
        output.extend(processWindows(tmp))
        command3 = Command(cmd3, '.')
        tmp = command3.run(timeout=5)
        output.extend(processWindows(tmp))
    elif platform.system() == 'Linux':
        cmd = ["sh", "-c", "dpkg -l"]
        command = Command(cmd, '.')
        output = command.run(timeout=5)
        output = output[5:]#cut dpkg explains and table head
        output = processLinux(output)
        #print(output[0])
        #print(output[-1])
    else:
        print("The OS %s is not supported!" % platform.system())
        exit()
    return output

if __name__ == "__main__":
    pipEntries = getPIPFreeze()
    print(pipEntries[0], '_', pipEntries[-1])
    #print(pipEntries)
    print('python pip packages', len(pipEntries))
    lst = look_entries(pipEntries)
    print('Summarize pip')
    printTable(lst)
    installedEntries = getInstalledProgram()
    print(installedEntries[0], installedEntries[-1])
    #print(installedEntries)
    print('OS programs', len(installedEntries))
    lst = look_entries(installedEntries)
    print('Summarize OS')
    printTable(lst)
